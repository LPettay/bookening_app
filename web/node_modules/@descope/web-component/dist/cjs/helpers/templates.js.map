{"version":3,"file":"templates.js","sources":["../../../src/lib/helpers/templates.ts"],"sourcesContent":["import { escapeMarkdown } from '@descope/escape-markdown';\nimport {\n  ELEMENT_TYPE_ATTRIBUTE,\n  DESCOPE_ATTRIBUTE_EXCLUDE_FIELD,\n  HAS_DYNAMIC_VALUES_ATTR_NAME,\n} from '../constants';\nimport { ComponentsConfig, CssVars, ScreenState } from '../types';\nimport { shouldHandleMarkdown } from './helpers';\n\nconst ALLOWED_INPUT_CONFIG_ATTRS = ['disabled'];\n\nexport const replaceElementMessage = (\n  baseEle: HTMLElement,\n  eleType: string,\n  message = '',\n) => {\n  const eleList = baseEle.querySelectorAll(\n    `[${ELEMENT_TYPE_ATTRIBUTE}=\"${eleType}\"]`,\n  );\n  eleList.forEach((ele: HTMLElement) => {\n    // eslint-disable-next-line no-param-reassign\n    ele.textContent = message;\n    ele.classList[message ? 'remove' : 'add']('hide');\n  });\n};\n\n/**\n * Replace the 'value' attribute of screen inputs with screen state's inputs.\n * For example: if base element contains '<input name=\"key1\" ...>' and screen input is in form of { key1: 'val1' },\n * it will add 'val1' as the input value\n */\nconst replaceElementInputs = (\n  baseEle: HTMLElement,\n  screenInputs: Record<string, string>,\n) => {\n  Object.entries(screenInputs || {}).forEach(([name, value]) => {\n    const inputEls = Array.from(\n      baseEle.querySelectorAll(\n        `*[name=\"${name}\"]:not([${DESCOPE_ATTRIBUTE_EXCLUDE_FIELD}])`,\n      ),\n    ) as HTMLInputElement[];\n    inputEls.forEach((inputEle) => {\n      // eslint-disable-next-line no-param-reassign\n      inputEle.value = value;\n    });\n  });\n};\n\n/**\n * Get object nested path.\n * Examples:\n *  - getByPath({ { a { b: 'rob' } }, 'a.b') => 'hey rob'\n *  - getByPath({}, 'a.b') => ''\n */\nconst getByPath = (obj: Record<string, any>, path: string) =>\n  path.split('.').reduce((prev, next) => prev?.[next] || '', obj);\n\n/**\n * Apply template language on text, based on screen state.\n * Examples:\n *  - 'hey {{a.b}}', { a { b: 'rob' }} => 'hey rob'\n *  - 'hey {{not.exists}}', {} => 'hey '\n */\nconst applyTemplates = (\n  text: string,\n  screenState?: Record<string, any>,\n  handleMarkdown?: boolean,\n): string =>\n  text.replace(/{{(.+?)}}/g, (_, match) =>\n    handleMarkdown\n      ? escapeMarkdown(getByPath(screenState, match))\n      : getByPath(screenState, match),\n  );\n\n/**\n * Replace the templates of content of inner text/link elements with screen state data\n */\nconst replaceElementTemplates = (\n  baseEle: DocumentFragment,\n  screenState?: Record<string, any>,\n) => {\n  const eleList = baseEle.querySelectorAll(\n    'descope-text,descope-link,descope-enriched-text,descope-code-snippet',\n  );\n  eleList.forEach((inEle: HTMLElement) => {\n    const handleMarkdown = shouldHandleMarkdown(inEle.localName);\n    // eslint-disable-next-line no-param-reassign\n    inEle.textContent = applyTemplates(\n      inEle.textContent,\n      screenState,\n      handleMarkdown,\n    );\n    const href = inEle.getAttribute('href');\n    if (href) {\n      inEle.setAttribute('href', applyTemplates(href, screenState));\n    }\n  });\n};\n\nconst replaceTemplateDynamicAttrValues = (\n  baseEle: DocumentFragment,\n  screenState?: Record<string, any>,\n) => {\n  const eleList = baseEle.querySelectorAll(`[${HAS_DYNAMIC_VALUES_ATTR_NAME}]`);\n  eleList.forEach((ele: HTMLElement) => {\n    Array.from(ele.attributes).forEach((attr) => {\n      // eslint-disable-next-line no-param-reassign\n      attr.value = applyTemplates(attr.value, screenState);\n    });\n  });\n};\n\nconst replaceHrefByDataType = (\n  baseEle: DocumentFragment,\n  dataType: string,\n  provisionUrl?: string,\n) => {\n  const eleList = baseEle.querySelectorAll(\n    `[${ELEMENT_TYPE_ATTRIBUTE}=\"${dataType}\"]`,\n  );\n  eleList.forEach((ele: HTMLLinkElement) => {\n    // eslint-disable-next-line no-param-reassign\n    ele.setAttribute('href', provisionUrl);\n  });\n};\n\nconst setFormConfigValues = (\n  baseEle: DocumentFragment,\n  formData: Record<string, string>,\n) => {\n  Object.entries(formData).forEach(([name, config]) => {\n    const eles = baseEle.querySelectorAll(`[name=\"${name}\"]`);\n\n    eles.forEach((ele) => {\n      Object.entries(config).forEach(([attrName, attrValue]) => {\n        if (ALLOWED_INPUT_CONFIG_ATTRS.includes(attrName)) {\n          ele.setAttribute(attrName, attrValue);\n        }\n      });\n    });\n  });\n};\n\nexport const setCssVars = (\n  rootEle: HTMLElement,\n  nextPageTemplate: DocumentFragment,\n  cssVars: CssVars,\n  logger: {\n    error: (message: string, description: string) => void;\n    info: (message: string, description: string) => void;\n    debug: (message: string, description: string) => void;\n  },\n) => {\n  if (!cssVars) {\n    return;\n  }\n\n  Object.keys(cssVars).forEach((componentName) => {\n    if (!nextPageTemplate.querySelector(componentName)) {\n      logger.debug(\n        `Skipping css vars for component \"${componentName}}\"`,\n        `Got css vars for component ${componentName} but Could not find it on next page`,\n      );\n    }\n    const componentClass:\n      | (CustomElementConstructor & { cssVarList: CssVars })\n      | undefined = customElements.get(componentName) as any;\n\n    if (!componentClass) {\n      logger.info(\n        `Could not find component class for ${componentName}`,\n        'Check if the component is registered',\n      );\n      return;\n    }\n\n    Object.keys(cssVars[componentName]).forEach((cssVarKey) => {\n      const componentCssVars = cssVars[componentName];\n      const varName = componentClass?.cssVarList?.[cssVarKey];\n\n      if (!varName) {\n        logger.info(\n          `Could not find css variable name for ${cssVarKey} in ${componentName}`,\n          'Check if the css variable is defined in the component',\n        );\n        return;\n      }\n\n      const value = componentCssVars[cssVarKey];\n\n      rootEle.style.setProperty(varName, value);\n    });\n  });\n};\n\nconst setElementConfig = (\n  baseEle: DocumentFragment,\n  componentsConfig: ComponentsConfig,\n  logger?: { error: (message: string, description: string) => void },\n) => {\n  if (!componentsConfig) {\n    return;\n  }\n  const { componentsDynamicAttrs, ...rest } = componentsConfig;\n\n  const configMap = Object.keys(rest).reduce((acc, componentName) => {\n    acc[`[name=${componentName}]`] = rest[componentName];\n    return acc;\n  }, {});\n\n  if (componentsDynamicAttrs) {\n    Object.keys(componentsDynamicAttrs).forEach((componentSelector) => {\n      const componentDynamicAttrs = componentsDynamicAttrs[componentSelector];\n      if (componentDynamicAttrs) {\n        const { attributes } = componentDynamicAttrs;\n        if (attributes && Object.keys(attributes).length) {\n          configMap[componentSelector] = attributes;\n        }\n      }\n    });\n  }\n\n  // collect components that needs configuration from DOM\n  Object.keys(configMap).forEach((componentsSelector) => {\n    baseEle.querySelectorAll(componentsSelector).forEach((comp) => {\n      const config = configMap[componentsSelector];\n\n      Object.keys(config).forEach((attr) => {\n        let value = config[attr];\n\n        if (typeof value !== 'string') {\n          try {\n            value = JSON.stringify(value);\n          } catch (e) {\n            logger.error(\n              `Could not stringify value \"${value}\" for \"${attr}\"`,\n              e.message,\n            );\n            value = '';\n          }\n        }\n\n        comp.setAttribute(attr, value);\n      });\n    });\n  });\n};\n\nconst setImageVariable = (\n  rootEle: HTMLElement,\n  name: string,\n  image?: string,\n) => {\n  const imageVarName = (\n    customElements.get(name) as CustomElementConstructor & {\n      cssVarList: Record<string, string>;\n    }\n  )?.cssVarList.url;\n\n  if (image && imageVarName) {\n    rootEle?.style?.setProperty(\n      imageVarName,\n      `url(data:image/jpg;base64,${image})`,\n    );\n  }\n};\n\n/**\n * Update a screen template based on the screen state\n *  - Show/hide error messages\n *  - Replace element templates ({{...}} syntax) with screen state object\n */\nexport const updateTemplateFromScreenState = (\n  baseEle: DocumentFragment,\n  screenState?: ScreenState,\n  componentsConfig?: ComponentsConfig,\n  flowInputs?: Record<string, string>,\n  logger?: { error: (message: string, description: string) => void },\n) => {\n  replaceHrefByDataType(baseEle, 'totp-link', screenState?.totp?.provisionUrl);\n  replaceHrefByDataType(baseEle, 'notp-link', screenState?.notp?.redirectUrl);\n  replaceElementTemplates(baseEle, screenState);\n  setElementConfig(baseEle, componentsConfig, logger);\n  replaceTemplateDynamicAttrValues(baseEle, screenState);\n  setFormConfigValues(baseEle, flowInputs);\n};\n\n/**\n * Update a screen based on a screen state\n *  - Replace values of element inputs with screen state's inputs\n */\nexport const updateScreenFromScreenState = (\n  baseEle: HTMLElement,\n  screenState?: ScreenState,\n) => {\n  replaceElementInputs(baseEle, screenState?.inputs);\n  replaceElementInputs(baseEle, screenState?.form);\n};\n\nexport const setTOTPVariable = (rootEle: HTMLElement, image?: string) => {\n  setImageVariable(rootEle, 'descope-totp-image', image);\n};\n\nexport const setNOTPVariable = (rootEle: HTMLElement, image?: string) => {\n  setImageVariable(rootEle, 'descope-notp-image', image);\n};\n\nexport const setPhoneAutoDetectDefaultCode = (\n  fragment: DocumentFragment,\n  autoDetectCode?: string,\n) => {\n  Array.from(fragment.querySelectorAll('[default-code=\"autoDetect\"]')).forEach(\n    (phoneEle) => {\n      phoneEle.setAttribute('default-code', autoDetectCode);\n    },\n  );\n};\n\nexport const disableWebauthnButtons = (fragment: DocumentFragment) => {\n  const webauthnButtons = fragment.querySelectorAll(\n    `descope-button[${ELEMENT_TYPE_ATTRIBUTE}=\"biometrics\"]`,\n  );\n  webauthnButtons.forEach((button) => button.setAttribute('disabled', 'true'));\n};\n\nexport const getDescopeUiComponentsList = (clone: DocumentFragment) => [\n  ...Array.from(clone.querySelectorAll('*')).reduce<Set<string>>(\n    (acc, el: HTMLElement) =>\n      el.tagName.startsWith('DESCOPE-')\n        ? acc.add(el.tagName.toLocaleLowerCase())\n        : acc,\n    new Set(),\n  ),\n];\n"],"names":["ALLOWED_INPUT_CONFIG_ATTRS","replaceElementInputs","baseEle","screenInputs","Object","entries","forEach","name","value","Array","from","querySelectorAll","DESCOPE_ATTRIBUTE_EXCLUDE_FIELD","inputEle","getByPath","obj","path","split","reduce","prev","next","applyTemplates","text","screenState","handleMarkdown","replace","_","match","escapeMarkdown","replaceHrefByDataType","dataType","provisionUrl","ELEMENT_TYPE_ATTRIBUTE","ele","setAttribute","setImageVariable","rootEle","image","imageVarName","_a","customElements","get","cssVarList","url","_b","style","setProperty","fragment","button","eleType","message","textContent","classList","nextPageTemplate","cssVars","logger","keys","componentName","querySelector","debug","componentClass","cssVarKey","componentCssVars","varName","info","autoDetectCode","phoneEle","inputs","form","componentsConfig","flowInputs","totp","notp","redirectUrl","inEle","shouldHandleMarkdown","localName","href","getAttribute","replaceElementTemplates","componentsDynamicAttrs","rest","__rest","configMap","acc","componentSelector","componentDynamicAttrs","attributes","length","componentsSelector","comp","config","attr","JSON","stringify","e","error","setElementConfig","HAS_DYNAMIC_VALUES_ATTR_NAME","replaceTemplateDynamicAttrValues","formData","attrName","attrValue","includes","setFormConfigValues"],"mappings":"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"}