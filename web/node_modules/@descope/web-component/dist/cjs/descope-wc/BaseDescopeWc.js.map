{"version":3,"file":"BaseDescopeWc.js","sources":["../../../src/lib/descope-wc/BaseDescopeWc.ts"],"sourcesContent":["import { compose } from '@descope/sdk-helpers';\n// eslint-disable-next-line import/no-duplicates\nimport { staticResourcesMixin } from '@descope/sdk-mixins/static-resources-mixin';\n// eslint-disable-next-line import/no-duplicates\nimport { themeMixin } from '@descope/sdk-mixins/theme-mixin';\n// eslint-disable-next-line import/no-duplicates\nimport { injectStyleMixin } from '@descope/sdk-mixins/inject-style-mixin';\nimport createSdk from '@descope/web-js-sdk';\nimport {\n  CONFIG_FILENAME,\n  ELEMENTS_TO_IGNORE_ENTER_KEY_ON,\n  FETCH_EXCEPTION_ERROR_CODE,\n  PREV_VER_ASSETS_FOLDER,\n} from '../constants';\nimport {\n  camelCase,\n  clearRunIdsFromUrl,\n  fetchContent,\n  getContentUrl,\n  getRunIdsFromUrl,\n  handleUrlParams,\n  State,\n} from '../helpers';\nimport {\n  extractNestedAttribute,\n  transformFlowInputFormData,\n} from '../helpers/flowInputs';\nimport { IsChanged } from '../helpers/state';\nimport { formMountMixin } from '../mixins';\nimport {\n  AutoFocusOptions,\n  DebuggerMessage,\n  DebugState,\n  DescopeUI,\n  FlowConfig,\n  FlowState,\n  FlowStateUpdateFn,\n  FlowStatus,\n  ProjectConfiguration,\n  SdkConfig,\n} from '../types';\n\n// this is replaced in build time\ndeclare const BUILD_VERSION: string;\n\nconst BaseClass = compose(\n  themeMixin,\n  staticResourcesMixin,\n  formMountMixin,\n  injectStyleMixin,\n)(HTMLElement);\n\n// this base class is responsible for WC initialization\nclass BaseDescopeWc extends BaseClass {\n  static get observedAttributes() {\n    return [\n      'project-id',\n      'flow-id',\n      'base-url',\n      'tenant',\n      'locale',\n      'debug',\n      'storage-prefix',\n      'preview',\n      'redirect-url',\n      'auto-focus',\n      'store-last-authenticated-user',\n      'refresh-cookie-name',\n      'keep-last-authenticated-user-after-logout',\n      'validate-on-blur',\n      'style-id',\n    ];\n  }\n\n  // this is a way for extending the sdk config from outside\n  static sdkConfigOverrides: Partial<SdkConfig> = {\n    baseHeaders: {\n      'x-descope-sdk-name': 'web-component',\n      'x-descope-sdk-version': BUILD_VERSION,\n    },\n  };\n\n  #init = false;\n\n  flowStatus: FlowStatus = 'initial';\n\n  loggerWrapper = {\n    error: (message: string, description = '') => {\n      this.logger.error(message, description, new Error());\n      this.#updateDebuggerMessages(message, description);\n    },\n    warn: (message: string, description = '') => {\n      this.logger.warn(message, description);\n    },\n    info: (message: string, description = '', state: any = {}) => {\n      this.logger.info(message, description, state);\n    },\n    debug: (message: string, description = '') => {\n      this.logger.debug(message, description);\n    },\n  };\n\n  #flowState = new State<FlowState>();\n\n  #debugState = new State<DebugState>();\n\n  #componentsContext = {};\n\n  getComponentsContext = () => this.#componentsContext;\n\n  nextRequestStatus = new State<{ isLoading: boolean }>({ isLoading: false });\n\n  rootElement: HTMLDivElement;\n\n  contentRootElement: HTMLDivElement;\n\n  slotElement: HTMLSlotElement;\n\n  #debuggerEle: HTMLElement & {\n    updateData: (data: DebuggerMessage | DebuggerMessage[]) => void;\n  };\n\n  #eventsCbRefs = {\n    popstate: this.#syncStateIdFromUrl.bind(this),\n    componentsContext: this.#handleComponentsContext.bind(this),\n  };\n\n  sdk: ReturnType<typeof createSdk>;\n\n  #updateExecState: FlowStateUpdateFn;\n\n  descopeUI: Promise<DescopeUI>;\n\n  constructor(updateExecState: FlowStateUpdateFn) {\n    super();\n    this.#updateExecState = updateExecState;\n\n    this.#initShadowDom();\n  }\n\n  #loadInitStyle() {\n    this.injectStyle(`\n    :host {\n\t\t\twidth: 100%;\n      display: block;\n\t\t}\n\n\t\t#root {\n\t\t\theight: 100%;\n      display: flex;\n      flex-direction: column;\n\t\t}\n\n    #content-root {\n      all: initial;\n      transition: opacity 200ms ease-in-out;\n    }\n\n\t\t#root[data-theme] {\n\t\t\tbackground-color: transparent;\n\t\t}\n\n\t\t.fade-out {\n\t\t\topacity: 0.1!important;\n\t\t}\n\n    .hidden {\n      display: none;\n    }\n    `);\n  }\n\n  #initShadowDom() {\n    this.#loadInitStyle();\n    this.slotElement = document.createElement('slot');\n    this.slotElement.classList.add('hidden');\n    this.rootElement.appendChild(this.slotElement);\n  }\n\n  get flowId() {\n    return this.getAttribute('flow-id');\n  }\n\n  get client() {\n    try {\n      return (JSON.parse(this.getAttribute('client')) || {}) as Record<\n        string,\n        any\n      >;\n    } catch (e) {\n      return {};\n    }\n  }\n\n  get tenantId() {\n    return this.getAttribute('tenant') || undefined;\n  }\n\n  get redirectUrl() {\n    return this.getAttribute('redirect-url') || undefined;\n  }\n\n  get debug() {\n    return this.getAttribute('debug') === 'true';\n  }\n\n  get locale() {\n    return this.getAttribute('locale') || undefined;\n  }\n\n  get autoFocus(): AutoFocusOptions {\n    const res = this.getAttribute('auto-focus') ?? 'true';\n    if (res === 'skipFirstScreen') {\n      return res;\n    }\n    return res === 'true';\n  }\n\n  get validateOnBlur() {\n    return this.getAttribute('validate-on-blur') === 'true';\n  }\n\n  get storeLastAuthenticatedUser() {\n    const res = this.getAttribute('store-last-authenticated-user') ?? 'true';\n    return res === 'true';\n  }\n\n  get refreshCookieName() {\n    return this.getAttribute('refresh-cookie-name') || '';\n  }\n\n  get keepLastAuthenticatedUserAfterLogout() {\n    const res = this.getAttribute('keep-last-authenticated-user-after-logout');\n    return res === 'true';\n  }\n\n  get storagePrefix() {\n    return this.getAttribute('storage-prefix') || '';\n  }\n\n  get preview() {\n    return !!this.getAttribute('preview');\n  }\n\n  get formConfig() {\n    return transformFlowInputFormData(this.form);\n  }\n\n  get form() {\n    return this.getAttribute('form');\n  }\n\n  get formConfigValues() {\n    return extractNestedAttribute(this.formConfig, 'value');\n  }\n\n  get outboundAppId() {\n    return this.getAttribute('outbound-app-id');\n  }\n\n  get outboundAppScopes() {\n    try {\n      const scopes = JSON.parse(this.getAttribute('outbound-app-scopes'));\n      if (!scopes) return null;\n      return scopes;\n    } catch (err) {\n      return null;\n    }\n  }\n\n  #validateAttrs() {\n    const optionalAttributes = [\n      'base-url',\n      'tenant',\n      'locale',\n      'debug',\n      'redirect-url',\n      'auto-focus',\n      'store-last-authenticated-user',\n      'refresh-cookie-name',\n      'keep-last-authenticated-user-after-logout',\n      'preview',\n      'storage-prefix',\n      'form',\n      'client',\n      'validate-on-blur',\n      'style-id',\n      'outbound-app-id',\n      'outbound-app-scopes',\n    ];\n\n    BaseDescopeWc.observedAttributes.forEach((attr: string) => {\n      if (!optionalAttributes.includes(attr) && !this[camelCase(attr)])\n        throw Error(`${attr} cannot be empty`);\n    });\n  }\n\n  #syncStateIdFromUrl() {\n    const { stepId, executionId } = getRunIdsFromUrl(this.flowId);\n    this.#flowState.update({ stepId, executionId });\n  }\n\n  #createSdk(projectId: string, baseUrl: string) {\n    this.sdk = createSdk({\n      // Use persist tokens options in order to add existing tokens in outgoing requests (if they exists)\n      persistTokens: true,\n      preview: this.preview,\n      storagePrefix: this.storagePrefix,\n      storeLastAuthenticatedUser: this.storeLastAuthenticatedUser,\n      keepLastAuthenticatedUserAfterLogout:\n        this.keepLastAuthenticatedUserAfterLogout,\n      refreshCookieName: this.refreshCookieName,\n      ...BaseDescopeWc.sdkConfigOverrides,\n      projectId,\n      baseUrl,\n    });\n\n    // we are wrapping the next & start function so we can indicate the request status\n    ['start', 'next'].forEach((key) => {\n      const origFn = this.sdk.flow[key];\n\n      this.sdk.flow[key] = async (...args: Parameters<typeof origFn>) => {\n        try {\n          const resp = await origFn(...args);\n          return resp;\n        } catch (e) {\n          // return a generic error object in case of an error\n          return {\n            error: {\n              errorCode: FETCH_EXCEPTION_ERROR_CODE,\n              errorDescription: e.toString(),\n            },\n          };\n        }\n      };\n    });\n  }\n\n  async #onFlowChange(\n    currentState: FlowState,\n    _prevState: FlowState,\n    isChanged: IsChanged<FlowState>,\n  ) {\n    const { projectId, baseUrl } = currentState;\n\n    const shouldCreateSdkInstance =\n      isChanged('projectId') || isChanged('baseUrl');\n\n    if (shouldCreateSdkInstance) {\n      if (!projectId) return;\n      // Initialize the sdk when got a new project id\n      this.#createSdk(projectId, baseUrl);\n    }\n\n    // update runtime state\n    this.#updateExecState(currentState);\n  }\n\n  async #getIsFlowsVersionMismatch() {\n    const config = await this.getConfig();\n\n    return (\n      'isMissingConfig' in config &&\n      config.isMissingConfig &&\n      (await this.#isPrevVerConfig())\n    );\n  }\n\n  // we are not using fetchStaticResource here\n  // because we do not want to use the fallbacks mechanism\n  async #isPrevVerConfig() {\n    const prevVerConfigUrl = getContentUrl({\n      projectId: this.projectId,\n      filename: CONFIG_FILENAME,\n      assetsFolder: PREV_VER_ASSETS_FOLDER,\n      baseUrl: this.baseStaticUrl,\n    });\n    try {\n      await fetchContent(prevVerConfigUrl, 'json');\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  getConfig = async () => (await this.config) || { isMissingConfig: true };\n\n  #handleComponentsContext(e: CustomEvent) {\n    this.#componentsContext = { ...this.#componentsContext, ...e.detail };\n  }\n\n  get isRestartOnError() {\n    return this.getAttribute('restart-on-error') === 'true';\n  }\n\n  async getExecutionContext() {\n    const config = await this.getConfig();\n    return 'executionContext' in config ? config.executionContext : undefined;\n  }\n\n  #disableDebugger() {\n    this.#debuggerEle?.remove();\n    this.#debuggerEle = null;\n  }\n\n  async #handleDebugMode({ isDebug }) {\n    if (isDebug) {\n      this.#debuggerEle = document.createElement(\n        'descope-debugger',\n      ) as HTMLElement & {\n        updateData: (data: DebuggerMessage | DebuggerMessage[]) => void;\n      };\n\n      Object.assign(this.#debuggerEle.style, {\n        position: 'fixed',\n        top: '0',\n        right: '0',\n        height: '100vh',\n        width: '100vw',\n        pointerEvents: 'none',\n        zIndex: 99999,\n      });\n\n      // we are importing the debugger dynamically so we won't load it when it's not needed\n      await import('../debugger-wc');\n\n      document.body.appendChild(this.#debuggerEle);\n    } else {\n      this.#disableDebugger();\n    }\n  }\n\n  #updateDebuggerMessages(title: string, description: string) {\n    if (title && this.debug)\n      this.#debuggerEle?.updateData({ title, description });\n  }\n\n  async getProjectConfig(): Promise<ProjectConfiguration> {\n    const config = await this.getConfig();\n    return 'projectConfig' in config ? config.projectConfig : undefined;\n  }\n\n  async getFlowConfig(): Promise<FlowConfig> {\n    const projectConfig = await this.getProjectConfig();\n\n    const flowConfig =\n      projectConfig?.flows?.[this.flowId] || ({} as FlowConfig);\n    flowConfig.version ??= 0;\n    return flowConfig;\n  }\n\n  async getTargetLocales() {\n    const flowConfig = await this.getFlowConfig();\n    return (flowConfig?.targetLocales || []).map((locale: string) =>\n      locale.toLowerCase(),\n    );\n  }\n\n  #handleKeyPress() {\n    // we want to simulate submit when the user presses Enter\n    this.rootElement.onkeydown = (e) => {\n      // we do not want to submit the form if the focus is on a link element\n      const isLinkEleFocused =\n        !!this.shadowRoot.activeElement?.getAttribute('href');\n      const isIgnoredElementFocused = ELEMENTS_TO_IGNORE_ENTER_KEY_ON.includes(\n        this.shadowRoot.activeElement?.localName ?? '',\n      );\n\n      if (e.key !== 'Enter' || isLinkEleFocused || isIgnoredElementFocused)\n        return;\n\n      e.preventDefault();\n      const buttons: NodeListOf<HTMLButtonElement> =\n        this.rootElement.querySelectorAll('descope-button');\n\n      // in case there is a single button on the page, click on it\n      if (\n        buttons.length === 1 &&\n        buttons[0].getAttribute('auto-submit') !== 'false'\n      ) {\n        buttons[0].click();\n        return;\n      }\n\n      const autoSubmitButtons = Array.from(buttons).filter(\n        (button) => button.getAttribute('auto-submit') === 'true',\n      );\n      if (autoSubmitButtons.length === 1) {\n        autoSubmitButtons[0].click();\n        return;\n      }\n\n      const genericButtons = Array.from(buttons).filter(\n        (button) => button.getAttribute('data-type') === 'button',\n      );\n\n      // in case there is a single \"generic\" button on the page, click on it\n      if (genericButtons.length === 1) {\n        if (genericButtons[0].getAttribute('auto-submit') !== 'false') {\n          genericButtons[0].click();\n        }\n      } else if (genericButtons.length === 0) {\n        const ssoButtons = Array.from(buttons).filter(\n          (button) => button.getAttribute('data-type') === 'sso',\n        );\n\n        // in case there is a single \"sso\" button on the page, click on it\n        if (ssoButtons.length === 1) {\n          if (ssoButtons[0].getAttribute('auto-submit') !== 'false') {\n            ssoButtons[0].click();\n          }\n        }\n      }\n    };\n  }\n\n  async getComponentsVersion() {\n    const config = await this.getConfig();\n    const version =\n      'projectConfig' in config ? config.projectConfig?.componentsVersion : {};\n\n    if (version) return version;\n\n    this.logger.error('Did not get components version, using latest version');\n\n    return 'latest';\n  }\n\n  static descopeUI: any;\n\n  async init() {\n    this.flowStatus = 'loading';\n    ['ready', 'error', 'success'].forEach((status: FlowStatus) =>\n      this.addEventListener(status, () => {\n        this.flowStatus = status;\n      }),\n    );\n\n    await super.init?.();\n    this.#debugState.subscribe(this.#handleDebugMode.bind(this));\n    this.#debugState.update({ isDebug: this.debug });\n\n    this.#validateAttrs();\n\n    if (await this.#getIsFlowsVersionMismatch()) {\n      this.loggerWrapper.error(\n        'This SDK version does not support your flows version',\n        'Make sure to upgrade your flows to the latest version or use an older SDK version',\n      );\n\n      return;\n    }\n\n    const config = await this.getConfig();\n    if ('isMissingConfig' in config && config.isMissingConfig) {\n      this.loggerWrapper.error(\n        'Cannot get config file',\n        'Make sure that your projectId & flowId are correct',\n      );\n\n      return;\n    }\n\n    this.#handleKeyPress();\n\n    const {\n      executionId,\n      stepId,\n      token,\n      code,\n      isPopup,\n      exchangeError,\n      redirectAuthCallbackUrl,\n      redirectAuthBackupCallbackUri,\n      redirectAuthCodeChallenge,\n      redirectAuthInitiator,\n      ssoQueryParams,\n    } = handleUrlParams(this.flowId, this.loggerWrapper);\n\n    // we want to update the state when user clicks on back in the browser\n    window.addEventListener('popstate', this.#eventsCbRefs.popstate);\n\n    // adding event to listen to events coming from components (e.g. recaptcha risk token) that want to add data to the context\n    // this data will be sent to the server on the next request\n    window.addEventListener(\n      'components-context',\n      this.#eventsCbRefs.componentsContext,\n    );\n\n    this.#flowState.subscribe(this.#onFlowChange.bind(this));\n\n    this.#flowState.update({\n      projectId: this.projectId,\n      flowId: this.flowId,\n      baseUrl: this.baseUrl,\n      tenant: this.tenantId,\n      redirectUrl: this.redirectUrl,\n      locale: this.locale,\n      stepId,\n      executionId,\n      token,\n      code,\n      isPopup,\n      exchangeError,\n      redirectAuthCallbackUrl,\n      redirectAuthBackupCallbackUri,\n      redirectAuthCodeChallenge,\n      redirectAuthInitiator,\n      ...ssoQueryParams,\n    });\n\n    this.#init = true;\n  }\n\n  disconnectedCallback() {\n    this.#flowState.unsubscribeAll();\n    this.#debugState.unsubscribeAll();\n    this.#disableDebugger();\n    window.removeEventListener('popstate', this.#eventsCbRefs.popstate);\n    window.removeEventListener(\n      'components-context',\n      this.#eventsCbRefs.componentsContext,\n    );\n  }\n\n  attributeChangedCallback(\n    attrName: string,\n    oldValue: string,\n    newValue: string,\n  ) {\n    if (!this.shadowRoot.isConnected || !this.#init) return;\n\n    if (\n      oldValue !== newValue &&\n      BaseDescopeWc.observedAttributes.includes(attrName)\n    ) {\n      this.#validateAttrs();\n\n      const isInitialRun = oldValue === null;\n\n      this.#flowState.update(({ stepId, executionId }) => {\n        let newStepId = stepId;\n        let newExecutionId = executionId;\n\n        // If not initial run and we got a new project/flow, we want to restart the step\n        if (!isInitialRun) {\n          newExecutionId = null;\n          newStepId = null;\n          clearRunIdsFromUrl();\n        }\n\n        return {\n          [camelCase(attrName)]: newValue,\n          stepId: newStepId,\n          executionId: newExecutionId,\n        };\n      });\n\n      this.#debugState.update({ isDebug: this.debug });\n    }\n  }\n}\n\nexport default BaseDescopeWc;\n"],"names":["BaseClass","compose","themeMixin","staticResourcesMixin","formMountMixin","injectStyleMixin","HTMLElement","BaseDescopeWc","observedAttributes","constructor","updateExecState","super","_BaseDescopeWc_init","set","this","flowStatus","loggerWrapper","error","message","description","logger","Error","__classPrivateFieldGet","call","warn","info","state","debug","_BaseDescopeWc_flowState","State","_BaseDescopeWc_debugState","_BaseDescopeWc_componentsContext","getComponentsContext","nextRequestStatus","isLoading","_BaseDescopeWc_debuggerEle","_BaseDescopeWc_eventsCbRefs","popstate","_BaseDescopeWc_instances","_BaseDescopeWc_syncStateIdFromUrl","bind","componentsContext","_BaseDescopeWc_handleComponentsContext","_BaseDescopeWc_updateExecState","getConfig","config","isMissingConfig","__classPrivateFieldSet","_BaseDescopeWc_initShadowDom","flowId","getAttribute","client","JSON","parse","e","tenantId","undefined","redirectUrl","locale","autoFocus","res","_b","validateOnBlur","storeLastAuthenticatedUser","refreshCookieName","keepLastAuthenticatedUserAfterLogout","storagePrefix","preview","formConfig","transformFlowInputFormData","form","formConfigValues","extractNestedAttribute","outboundAppId","outboundAppScopes","scopes","err","isRestartOnError","getExecutionContext","executionContext","getProjectConfig","projectConfig","getFlowConfig","flowConfig","flows","_c","version","getTargetLocales","targetLocales","map","toLowerCase","getComponentsVersion","componentsVersion","init","forEach","status","addEventListener","_super","subscribe","_BaseDescopeWc_handleDebugMode","update","isDebug","_BaseDescopeWc_validateAttrs","_BaseDescopeWc_getIsFlowsVersionMismatch","_BaseDescopeWc_handleKeyPress","executionId","stepId","token","code","isPopup","exchangeError","redirectAuthCallbackUrl","redirectAuthBackupCallbackUri","redirectAuthCodeChallenge","redirectAuthInitiator","ssoQueryParams","handleUrlParams","window","_BaseDescopeWc_onFlowChange","Object","assign","projectId","baseUrl","tenant","disconnectedCallback","unsubscribeAll","_BaseDescopeWc_disableDebugger","removeEventListener","attributeChangedCallback","attrName","oldValue","newValue","shadowRoot","isConnected","_a","includes","isInitialRun","newStepId","newExecutionId","clearRunIdsFromUrl","camelCase","injectStyle","_BaseDescopeWc_loadInitStyle","slotElement","document","createElement","classList","add","rootElement","appendChild","optionalAttributes","attr","getRunIdsFromUrl","_BaseDescopeWc_createSdk","sdk","createSdk","persistTokens","sdkConfigOverrides","key","origFn","flow","args","__awaiter","errorCode","FETCH_EXCEPTION_ERROR_CODE","errorDescription","toString","currentState","_prevState","isChanged","_BaseDescopeWc_isPrevVerConfig","prevVerConfigUrl","getContentUrl","filename","CONFIG_FILENAME","assetsFolder","PREV_VER_ASSETS_FOLDER","baseStaticUrl","fetchContent","detail","remove","arguments","style","position","top","right","height","width","pointerEvents","zIndex","Promise","resolve","then","_interopNamespaceDefaultOnly","require","body","_BaseDescopeWc_updateDebuggerMessages","title","updateData","onkeydown","isLinkEleFocused","activeElement","isIgnoredElementFocused","ELEMENTS_TO_IGNORE_ENTER_KEY_ON","localName","_d","preventDefault","buttons","querySelectorAll","length","click","autoSubmitButtons","Array","from","filter","button","genericButtons","ssoButtons","baseHeaders"],"mappings":"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"}