"use strict";var e,t,i,s,r,o,n,a,l,d,c,h,u,p,g,v,m,_,f,b,S,w,E,O,I,R,P,C,T,y,F,A,k,N,W,x=require("tslib"),L=require("@descope/web-js-sdk"),U=require("../constants/index.js"),G=require("../helpers/helpers.js"),j=require("../helpers/state.js"),D=require("../helpers/templates.js"),M=require("../helpers/webauthn.js"),q=require("../helpers/abTestingKey.js"),$=require("../helpers/conditions.js"),V=require("../helpers/lastAuth.js"),B=require("./BaseDescopeWc.js"),K=require("../constants/general.js");t=new WeakMap,i=new WeakMap,s=new WeakMap,r=new WeakMap,p=new WeakMap,v=new WeakMap,_=new WeakMap,f=new WeakMap,b=new WeakMap,S=new WeakMap,P=new WeakMap,A=new WeakMap,e=new WeakSet,o=function(){document.hidden||setTimeout((()=>{this.flowState.update({deferredRedirect:!1})}),300)},n=function(t,i,s){return x.__awaiter(this,void 0,void 0,(function*(){var r;return(null===(r=this.nativeOptions)||void 0===r?void 0:r.bridgeVersion)>=2&&new Promise((r=>{this.nativeCallbacks.screenNext=s,this.nativeCallbacks.screenResolve=r,x.__classPrivateFieldGet(this,e,"m",l).call(this,"beforeScreen",{screen:t,context:i})}))}))},a=function(t){var i;(null===(i=this.nativeOptions)||void 0===i?void 0:i.bridgeVersion)>=2&&x.__classPrivateFieldGet(this,e,"m",l).call(this,"afterScreen",{screen:t})},l=function(t,i){x.__classPrivateFieldGet(this,e,"m",W).call(this,"bridge",{type:t,payload:i})},d=function({errorText:e,errorType:t}){const i=()=>{var i;let s=e;try{s=(null===(i=this.errorTransformer)||void 0===i?void 0:i.call(this,{text:e,type:t}))||e}catch(e){this.loggerWrapper.error("Error transforming error message",e.message)}D.replaceElementMessage(this.contentRootElement,"error-message",s)};this.addEventListener("screen-updated",i,{once:!0}),i()},c=function(){var t,i,s;null===(t=this.stepState)||void 0===t||t.subscribe(this.onStepChange.bind(this),(e=>{var t=e.screenState,i=void 0===t?{}:t,s=x.__rest(i,["errorText","errorType"]),r=x.__rest(e,["screenState"]);return Object.assign(Object.assign({},r),{screenState:s})})),null===(i=this.stepState)||void 0===i||i.subscribe(x.__classPrivateFieldGet(this,e,"m",d).bind(this),(e=>{var t,i;return{errorText:null===(t=null==e?void 0:e.screenState)||void 0===t?void 0:t.errorText,errorType:null===(i=null==e?void 0:e.screenState)||void 0===i?void 0:i.errorType}}),{forceUpdate:!0}),null===(s=this.stepState)||void 0===s||s.subscribe(x.__classPrivateFieldGet(this,e,"m",h).bind(this),(e=>{var t,i;return{errorText:null===(t=null==e?void 0:e.screenState)||void 0===t?void 0:t.errorText,errorType:null===(i=null==e?void 0:e.screenState)||void 0===i?void 0:i.errorType}}),{forceUpdate:!0})},h=function({errorText:e,errorType:t}){(t||e)&&(this.contentRootElement.querySelectorAll('descope-passcode[data-auto-submit="true"]').forEach((e=>{e.shadowRoot.querySelectorAll("descope-text-field[data-id]").forEach((e=>{e.value=""}))})),G.handleAutoFocus(this.contentRootElement,this.autoFocus,!1))},u=function(){return x.__awaiter(this,void 0,void 0,(function*(){this.loggerWrapper.debug("Trying to restart the flow");const e=yield this.getComponentsVersion();this.reset();e===(yield this.getComponentsVersion())?(this.loggerWrapper.debug("Components version was not changed, restarting flow"),this.flowState.update({stepId:null,executionId:null})):this.loggerWrapper.error("Components version mismatch, please reload the page")}))},g=function(t){return x.__awaiter(this,void 0,void 0,(function*(){var i;const s=Object.assign(Object.assign({},this.stepState.current),t),{next:r,stepName:o}=s,a=x.__rest(s,["next","stepName"]),l=G.transformStepStateForCustomScreen(a);let d=yield x.__classPrivateFieldGet(this,e,"m",n).call(this,o,l,r);d||(d=Boolean(yield null===(i=this.onScreenUpdate)||void 0===i?void 0:i.call(this,o,l,r,this)));const h=!this.stepState.current.htmlFilename;if(x.__classPrivateFieldGet(this,v,"f").call(this,d),x.__classPrivateFieldGet(this,p,"f")!==d){const[t,i]=["flow","custom"].sort((()=>d?-1:1));this.loggerWrapper.debug(`Switching from ${i} screen to ${t} screen`),x.__classPrivateFieldSet(this,p,d,"f"),d?this.stepState.unsubscribeAll():x.__classPrivateFieldGet(this,e,"m",c).call(this)}d&&(this.loggerWrapper.debug("Showing a custom screen"),x.__classPrivateFieldGet(this,e,"m",O).call(this,{isFirstScreen:h,isCustomScreen:d,stepName:t.stepName})),this.stepState.forceUpdate=d}))},m=function(e){this.contentRootElement.addEventListener("transitionend",(()=>{this.loggerWrapper.debug("page switch transition end"),this.contentRootElement.classList.remove("fade-out"),e()}),{once:!0}),this.loggerWrapper.debug("page switch transition start"),this.contentRootElement.classList.add("fade-out")},w=function(e){const t=e.getAttribute("name");if(!["email"].includes(t)){const i=`user-${t}`;e.setAttribute("name",i),e.addEventListener("input",(()=>{e.setAttribute("name",e.value?t:i)}))}},E=function(t,s){return x.__awaiter(this,void 0,void 0,(function*(){var r;null===(r=x.__classPrivateFieldGet(this,i,"f"))||void 0===r||r.abort();const o=t.querySelector('*[autocomplete="webauthn"]');if(o&&(yield M.isConditionalLoginSupported())){const{options:t,transactionId:r}=(yield x.__classPrivateFieldGet(this,S,"f").call(this))||{};t&&r&&(x.__classPrivateFieldGet(this,e,"m",w).call(this,o),x.__classPrivateFieldSet(this,i,new AbortController,"f"),this.sdk.webauthn.helpers.conditional(t,x.__classPrivateFieldGet(this,i,"f")).then((e=>x.__awaiter(this,void 0,void 0,(function*(){s(o.id,{transactionId:r,response:e})})))).catch((e=>{"AbortError"!==e.name&&this.loggerWrapper.error("Conditional login failed",e.message)})))}}))},O=function({isFirstScreen:t,isCustomScreen:i,stepName:s}){t&&x.__classPrivateFieldGet(this,e,"m",W).call(this,"ready",{}),i||x.__classPrivateFieldGet(this,e,"m",a).call(this,s),x.__classPrivateFieldGet(this,e,"m",W).call(this,"page-updated",{screenName:s}),x.__classPrivateFieldGet(this,e,"m",W).call(this,"screen-updated",{screenName:s})},I=function(){let e=!0;return Array.from(this.shadowRoot.querySelectorAll("*[name]")).reverse().forEach((t=>{var i,s;"slot"!==t.localName&&(null===(i=t.reportValidity)||void 0===i||i.call(t),e&&(e=null===(s=t.checkValidity)||void 0===s?void 0:s.call(t)))})),e},R=function(){return x.__awaiter(this,void 0,void 0,(function*(){const e=this.getInputs();return(yield Promise.all(e.map((e=>x.__awaiter(this,void 0,void 0,(function*(){return{name:e.getAttribute("name"),value:e.value}})))))).reduce(((e,t)=>Object.assign(Object.assign({},e),{[t.name]:t.value})),{})}))},C=function(e){const t=Array.from(this.contentRootElement.querySelectorAll(':not([disabled]), [disabled="false"]')).filter((t=>t!==e)),i=()=>x.__awaiter(this,void 0,void 0,(function*(){this.loggerWrapper.debug("Restoring components state"),this.removeEventListener("popupclosed",i),e.removeAttribute("loading"),t.forEach((e=>{e.removeAttribute("disabled")}));const s=yield this.getFlowConfig(),r=[...s.clientScripts||[],...s.sdkScripts||[]];this.loadSdkScripts(r)})),s=()=>{var e;window.removeEventListener("pageshow",x.__classPrivateFieldGet(this,P,"f")),x.__classPrivateFieldSet(this,P,(e=>{e.persisted&&(this.logger.debug("Page was loaded from cache, restoring components state"),i())}),"f"),window.addEventListener("pageshow",x.__classPrivateFieldGet(this,P,"f"),{once:!0});const t=null===(e=this.stepState)||void 0===e?void 0:e.subscribe(((e,s)=>{e===s&&i(),this.removeEventListener("popupclosed",i),this.stepState.unsubscribe(t)}),(e=>e.screenId),{forceUpdate:!0})},r=this.nextRequestStatus.subscribe((({isLoading:o})=>{o?(this.addEventListener("popupclosed",i,{once:!0}),e.setAttribute("loading","true"),t.forEach((e=>e.setAttribute("disabled","true")))):(this.nextRequestStatus.unsubscribe(r),s())}))},T=function(e={}){var t,i;const s=G.getFirstNonEmptyValue(e,["externalId","email","phone"]),r=G.getFirstNonEmptyValue(e,["newPassword","password"]);if(s&&r)try{if(!globalThis.PasswordCredential)return;const e=new globalThis.PasswordCredential({id:s,password:r});null===(i=null===(t=null===navigator||void 0===navigator?void 0:navigator.credentials)||void 0===t?void 0:t.store)||void 0===i||i.call(t,e)}catch(e){this.loggerWrapper.error("Could not store credentials",e.message)}},y=function(){G.clearPreviousExternalInputs();this.contentRootElement.querySelectorAll('[external-input="true"]').forEach((t=>x.__classPrivateFieldGet(this,e,"m",F).call(this,t)))},F=function(e){if(!e)return;e.querySelectorAll("input").forEach((t=>{const i=t.getAttribute("slot"),s=`input-${e.id}-${i}`,r=document.createElement("slot");r.setAttribute("name",s),r.setAttribute("slot",i),e.appendChild(r),t.setAttribute("slot",s),this.appendChild(t)}))},k=function(e){this.contentRootElement.querySelectorAll('descope-passcode[data-auto-submit="true"]').forEach((t=>{t.addEventListener("input",(()=>{var i;(null===(i=t.checkValidity)||void 0===i?void 0:i.call(t))&&x.__classPrivateFieldGet(this,A,"f").call(this,t,e)}))}))},N=function(t){this.contentRootElement.querySelectorAll(`descope-button:not([${U.DESCOPE_ATTRIBUTE_EXCLUDE_NEXT_BUTTON}]), [data-type="button"]:not([${U.DESCOPE_ATTRIBUTE_EXCLUDE_NEXT_BUTTON}]`).forEach((e=>{e.onclick=()=>{x.__classPrivateFieldGet(this,A,"f").call(this,e,t)}})),x.__classPrivateFieldGet(this,e,"m",k).call(this,t),this.isDismissScreenErrorOnInput&&this.contentRootElement.querySelectorAll(`*[name]:not([${U.DESCOPE_ATTRIBUTE_EXCLUDE_FIELD}])`).forEach((e=>{e.addEventListener("input",(()=>{this.stepState.update((e=>Object.assign(Object.assign({},e),{screenState:Object.assign(Object.assign({},e.screenState),{errorText:"",errorType:""})})))}))}))},W=function(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))},module.exports=class extends B{static set sdkConfigOverrides(e){B.sdkConfigOverrides=e}static get sdkConfigOverrides(){return B.sdkConfigOverrides}constructor(){const n=new j({deferredRedirect:!1});super(n.update.bind(n)),e.add(this),this.stepState=new j({}),t.set(this,void 0),i.set(this,null),s.set(this,null),r.set(this,{visibilitychange:x.__classPrivateFieldGet(this,e,"m",o).bind(this)}),this.bridgeVersion=2,this.nativeCallbacks={},p.set(this,!1),this.handleRedirect=e=>{window.location.assign(e)},v.set(this,(t=>{const i=()=>{this.contentRootElement.classList.toggle("hidden",t),this.slotElement.classList.toggle("hidden",!t),t&&(this.contentRootElement.innerHTML="")};t&&this.contentRootElement.hasChildNodes()?x.__classPrivateFieldGet(this,e,"m",m).call(this,i):i()})),_.set(this,((e,i,s,r,o=!1)=>{const n=[K.FLOW_TIMED_OUT_ERROR_CODE,K.POLLING_STATUS_NOT_FOUND_ERROR_CODE];if(this.flowState.current.action===U.RESPONSE_ACTIONS.poll){this.logger.debug("polling - Scheduling polling request");const a=Date.now(),l=o?500:2e3;x.__classPrivateFieldSet(this,t,setTimeout((()=>x.__awaiter(this,void 0,void 0,(function*(){var t,d;this.logger.debug("polling - Calling next");const c=this.sdk.flow.next(e,i,U.CUSTOM_INTERACTIONS.polling,s,r,{}),h=document.hidden&&!o&&Date.now()-a>l+500;let u;h&&this.logger.debug("polling - The polling seems to be throttled");try{const e=h?1e3:6e3;u=yield G.timeoutPromise(e,c)}catch(t){return this.logger.warn(`polling - The ${h?"throttled fetch":"fetch"} call timed out or was aborted`),void x.__classPrivateFieldGet(this,_,"f").call(this,e,i,s,r,h)}if((null===(t=null==u?void 0:u.error)||void 0===t?void 0:t.errorCode)===K.FETCH_EXCEPTION_ERROR_CODE)return this.logger.debug("polling - Got a generic error due to exception in fetch call"),void x.__classPrivateFieldGet(this,_,"f").call(this,e,i,s,r);this.logger.debug("polling - Got a response"),(null==u?void 0:u.error)&&this.logger.debug("polling - Response has an error",JSON.stringify(u.error,null,4)),(null===(d=null==u?void 0:u.error)||void 0===d?void 0:d.errorCode)&&n.includes(u.error.errorCode)?this.logger.debug("polling - Stopping polling due to error"):x.__classPrivateFieldGet(this,_,"f").call(this,e,i,s,r),x.__classPrivateFieldGet(this,b,"f").call(this,u)}))),l),"f")}})),f.set(this,(()=>{clearTimeout(x.__classPrivateFieldGet(this,t,"f")),x.__classPrivateFieldSet(this,t,null,"f")})),b.set(this,(t=>{var i,r,o,n,a,l,d,c,h,p,g,v,m;if(!(null==t?void 0:t.ok)){const s=null===(i=null==t?void 0:t.response)||void 0===i?void 0:i.url,d=`${null===(r=null==t?void 0:t.response)||void 0===r?void 0:r.status} - ${null===(o=null==t?void 0:t.response)||void 0===o?void 0:o.statusText}`;x.__classPrivateFieldGet(this,e,"m",W).call(this,"error",(null==t?void 0:t.error)||{errorCode:K.FETCH_ERROR_RESPONSE_ERROR_CODE,errorDescription:d,errorMessage:s}),this.loggerWrapper.error((null===(n=null==t?void 0:t.error)||void 0===n?void 0:n.errorDescription)||s,(null===(a=null==t?void 0:t.error)||void 0===a?void 0:a.errorMessage)||d);const c=null===(l=null==t?void 0:t.error)||void 0===l?void 0:l.errorCode;return void(c!==K.FLOW_REQUESTED_IS_IN_OLD_VERSION_ERROR_CODE&&c!==K.FLOW_TIMED_OUT_ERROR_CODE||!this.isRestartOnError||x.__classPrivateFieldGet(this,e,"m",u).call(this))}null===(c=null===(d=t.data)||void 0===d?void 0:d.runnerLogs)||void 0===c||c.forEach((e=>{const{level:t,title:i,log:s}=e;t&&this.loggerWrapper[t]?this.loggerWrapper[t](i,s):this.loggerWrapper.info(i,s)}));const _=null===(g=null===(p=null===(h=t.data)||void 0===h?void 0:h.screen)||void 0===p?void 0:p.state)||void 0===g?void 0:g.errorText;(null===(v=t.data)||void 0===v?void 0:v.error)?this.loggerWrapper.error(`[${t.data.error.code}]: ${t.data.error.description}`,`${_?`${_} - `:""}${t.data.error.message}`):_&&this.loggerWrapper.error(_);const{status:b,authInfo:S,lastAuth:w,action:E,openInNewTabUrl:O}=t.data;if(E!==U.RESPONSE_ACTIONS.poll&&x.__classPrivateFieldGet(this,f,"f").call(this),"completed"===b)return this.storeLastAuthenticatedUser&&V.setLastAuth(w),void x.__classPrivateFieldGet(this,e,"m",W).call(this,"success",S);this.storeLastAuthenticatedUser&&V.setLastAuth(w,!0),O&&window.open(O,"_blank");const{executionId:I,stepId:R,stepName:P,screen:C,redirect:T,webauthn:y,error:F,samlIdpResponse:A,nativeResponse:k}=t.data,N=Date.now();E!==U.RESPONSE_ACTIONS.poll?(this.loggerWrapper.info(`Step "${P||`#${R}`}" is ${b}`,"",{screen:C,status:b,stepId:R,stepName:P,action:E,error:F}),(null===(m=C.state)||void 0===m?void 0:m.clientScripts)&&x.__classPrivateFieldSet(this,s,this.loadSdkScripts(C.state.clientScripts),"f"),this.flowState.update({stepId:R,stepName:P,executionId:I,action:E,redirectTo:null==T?void 0:T.url,redirectIsPopup:null==T?void 0:T.isPopup,screenId:null==C?void 0:C.id,screenState:null==C?void 0:C.state,webauthnTransactionId:null==y?void 0:y.transactionId,webauthnOptions:null==y?void 0:y.options,samlIdpResponseUrl:null==A?void 0:A.url,samlIdpResponseSamlResponse:null==A?void 0:A.samlResponse,samlIdpResponseRelayState:null==A?void 0:A.relayState,nativeResponseType:null==k?void 0:k.type,nativePayload:null==k?void 0:k.payload,reqTimestamp:N})):this.flowState.update({action:E,reqTimestamp:N})})),S.set(this,G.withMemCache((()=>x.__awaiter(this,void 0,void 0,(function*(){var e;try{const t=yield this.sdk.webauthn.signIn.start("",window.location.origin);return t.ok||this.loggerWrapper.warn("Webauthn start failed",null===(e=null==t?void 0:t.error)||void 0===e?void 0:e.errorMessage),t.data}catch(e){this.loggerWrapper.warn("Webauthn start failed",e.message)}}))))),P.set(this,null),A.set(this,G.leadingDebounce(((t,i)=>x.__awaiter(this,void 0,void 0,(function*(){var r;if("true"===t.getAttribute("formnovalidate")||x.__classPrivateFieldGet(this,e,"m",I).call(this)){const o=null==t?void 0:t.getAttribute("id");x.__classPrivateFieldGet(this,e,"m",C).call(this,t);const n=yield x.__classPrivateFieldGet(this,e,"m",R).call(this),a=G.getElementDescopeAttributes(t);if(this.nextRequestStatus.update({isLoading:!0}),x.__classPrivateFieldGet(this,s,"f")){this.loggerWrapper.debug("Waiting for sdk scripts to load");const e=Date.now();yield x.__classPrivateFieldGet(this,s,"f"),this.loggerWrapper.debug("Sdk scripts loaded for",(Date.now()-e).toString())}const l=this.loadSdkScriptsModules();if(l.length>0){const e=l.filter((e=>"function"==typeof e.refresh)).map((e=>e.refresh()));e.length>0&&(yield G.timeoutPromise(U.SDK_SCRIPTS_LOAD_TIMEOUT,Promise.all(e),null))}const d=this.getComponentsContext(),c=Object.assign(Object.assign(Object.assign(Object.assign({},d),a),n),{origin:(null===(r=this.nativeOptions)||void 0===r?void 0:r.origin)||window.location.origin});yield i(o,c),this.nextRequestStatus.update({isLoading:!1}),x.__classPrivateFieldGet(this,e,"m",T).call(this,n)}}))))),this.flowState=n}nativeResume(e,t){var i,s,r,o,n;const a=JSON.parse(t);if("oauthWeb"===e||"sso"===e){let{exchangeCode:e}=a;if(!e){e=null===(i=new URL(a.url).searchParams)||void 0===i?void 0:i.get(U.URL_CODE_PARAM_NAME)}null===(r=(s=this.nativeCallbacks).complete)||void 0===r||r.call(s,{exchangeCode:e,idpInitiated:!0})}else if("magicLink"===e){const e=new URL(a.url),t=e.searchParams.get(U.URL_TOKEN_PARAM_NAME),i=e.searchParams.get(U.URL_RUN_IDS_PARAM_NAME).split("_").pop();x.__classPrivateFieldGet(this,f,"f").call(this),this.flowState.update({token:t,stepId:i,action:void 0})}else if("beforeScreen"===e){const{screenResolve:e}=this.nativeCallbacks;this.nativeCallbacks.screenResolve=null;const{override:t}=a;t||(this.nativeCallbacks.screenNext=null),null==e||e(t)}else if("resumeScreen"===e){const{interactionId:e,form:t}=a,{screenNext:i}=this.nativeCallbacks;this.nativeCallbacks.screenNext=null,null==i||i(e,t)}else null===(n=(o=this.nativeCallbacks).complete)||void 0===n||n.call(o,a)}loadSdkScriptsModules(){const e=this.shadowRoot.querySelectorAll("div[data-script-id]");return Array.from(e).map((e=>e.moduleRes)).filter((e=>!!e))}loadSdkScripts(e){if(!(null==e?void 0:e.length))return null;const t=(e,t)=>i=>{this.dispatchEvent(new CustomEvent("components-context",{detail:{[G.getScriptResultPath(e.id,e.resultKey)]:i},bubbles:!0,composed:!0})),t(e.id)};this.loggerWrapper.debug(`Preparing to load scripts: ${e.map((e=>e.id)).join(", ")}`);const i=Promise.all(null==e?void 0:e.map((e=>x.__awaiter(this,void 0,void 0,(function*(){var i,s;const r=this.shadowRoot.querySelector(`[data-script-id="${e.id}"]`);if(r){this.loggerWrapper.debug("Script already loaded",e.id);const{moduleRes:t}=r;return null===(i=null==t?void 0:t.start)||void 0===i||i.call(t),t}yield this.injectNpmLib("@descope/flow-scripts","1.0.11",`dist/${e.id}.js`);const o=null===(s=globalThis.descope)||void 0===s?void 0:s[e.id];return new Promise(((i,s)=>{try{const s=o(e.initArgs,{baseUrl:this.baseUrl,ref:this},t(e,i));if(s){const t=document.createElement("div");t.setAttribute("data-script-id",e.id),t.moduleRes=s,this.shadowRoot.appendChild(t),this.nextRequestStatus.subscribe((()=>{var t;this.loggerWrapper.debug("Unloading script",e.id),null===(t=s.stop)||void 0===t||t.call(s)}))}}catch(e){s(e)}}))}))))),s=new Promise((e=>{setTimeout((()=>{this.loggerWrapper.warn("SDK scripts loading timeout"),e(!0)}),U.SDK_SCRIPTS_LOAD_TIMEOUT)}));return Promise.race([i,s])}get isDismissScreenErrorOnInput(){return"true"===this.getAttribute("dismiss-screen-error-on-input")}init(){if(!window.descopeBridge)return this._init();this.lazyInit=this._init}_init(){const t=Object.create(null,{init:{get:()=>super.init}});return x.__awaiter(this,void 0,void 0,(function*(){var i,s;this.shadowRoot.isConnected&&(null===(i=this.flowState)||void 0===i||i.subscribe(this.onFlowChange.bind(this)),x.__classPrivateFieldGet(this,e,"m",c).call(this),window.addEventListener("visibilitychange",x.__classPrivateFieldGet(this,r,"f").visibilitychange)),yield null===(s=t.init)||void 0===s?void 0:s.call(this)}))}disconnectedCallback(){var e;super.disconnectedCallback(),this.flowState.unsubscribeAll(),this.stepState.unsubscribeAll(),null===(e=x.__classPrivateFieldGet(this,i,"f"))||void 0===e||e.abort(),x.__classPrivateFieldSet(this,i,null,"f"),window.removeEventListener("visibilitychange",x.__classPrivateFieldGet(this,r,"f").visibilitychange)}getHtmlFilenameWithLocale(e,t){return x.__awaiter(this,void 0,void 0,(function*(){let i;const s=G.getUserLocale(e),r=yield this.getTargetLocales();return r.includes(s.locale)?i=`${t}-${s.locale}.html`:r.includes(s.fallback)&&(i=`${t}-${s.fallback}.html`),i}))}getPageContent(e,t){return x.__awaiter(this,void 0,void 0,(function*(){if(t)try{const{body:e}=yield this.fetchStaticResource(t,"text");return e}catch(i){this.loggerWrapper.error(`Failed to fetch flow page from ${t}. Fallback to url ${e}`,i)}try{const{body:t}=yield this.fetchStaticResource(e,"text");return t}catch(e){this.loggerWrapper.error("Failed to fetch flow page",e.message)}return null}))}onFlowChange(t,r,o){return x.__awaiter(this,void 0,void 0,(function*(){var n,a;const{projectId:d,flowId:c,tenant:h,stepId:u,executionId:p,action:v,screenId:m,screenState:f,redirectTo:S,redirectIsPopup:w,redirectUrl:E,token:O,code:I,isPopup:R,exchangeError:P,webauthnTransactionId:C,webauthnOptions:T,redirectAuthCodeChallenge:y,redirectAuthCallbackUrl:F,redirectAuthBackupCallbackUri:A,redirectAuthInitiator:k,locale:N,samlIdpResponseUrl:j,samlIdpResponseSamlResponse:D,samlIdpResponseRelayState:M,nativeResponseType:B,nativePayload:K,reqTimestamp:H}=t,J=x.__rest(t,["projectId","flowId","tenant","stepId","executionId","action","screenId","screenState","redirectTo","redirectIsPopup","redirectUrl","token","code","isPopup","exchangeError","webauthnTransactionId","webauthnOptions","redirectAuthCodeChallenge","redirectAuthCallbackUrl","redirectAuthBackupCallbackUri","redirectAuthInitiator","locale","samlIdpResponseUrl","samlIdpResponseSamlResponse","samlIdpResponseRelayState","nativeResponseType","nativePayload","reqTimestamp"]);let X,z,Q;const Y=q.getABTestingKey(),{outboundAppId:Z}=this,{outboundAppScopes:ee}=this,te=this.sdk.getLastUserLoginId(),ie=yield this.getFlowConfig(),se=yield this.getProjectConfig(),re=Object.entries(se.flows||{}).reduce(((e,[t,i])=>(e[t]=i.version,e)),{}),oe=F&&y?{callbackUrl:F,codeChallenge:y,backupCallbackUri:A}:void 0,ne=this.nativeOptions?{platform:this.nativeOptions.platform,bridgeVersion:this.nativeOptions.bridgeVersion,oauthProvider:this.nativeOptions.oauthProvider,oauthRedirect:this.nativeOptions.oauthRedirect,magicLinkRedirect:this.nativeOptions.magicLinkRedirect,ssoRedirect:this.nativeOptions.ssoRedirect}:void 0;let ae={};if(!p){const e=[...ie.clientScripts||[],...ie.sdkScripts||[]];if(ie.conditions){let t=[];({startScreenId:X,conditionInteractionId:Q,startScreenName:z,clientScripts:t,componentsConfig:ae}=$.calculateConditions({loginId:te,code:I,token:O,abTestingKey:Y,lastAuth:V.getLastAuth(te)},ie.conditions)),e.push(...t||[])}else ie.condition?({startScreenId:X,conditionInteractionId:Q}=$.calculateCondition(ie.condition,{loginId:te,code:I,token:O,abTestingKey:Y,lastAuth:V.getLastAuth(te)})):(z=ie.startScreenName,X=ie.startScreenId);if(x.__classPrivateFieldSet(this,s,this.loadSdkScripts(e),"f"),ie.fingerprintEnabled&&ie.fingerprintKey?yield L.ensureFingerprintIds(ie.fingerprintKey,this.baseUrl):L.clearFingerprintData(),!G.showFirstScreenOnExecutionInit(X,J)){const e=yield this.sdk.flow.start(c,Object.assign(Object.assign(Object.assign(Object.assign({tenant:h,redirectAuth:oe},J),{client:this.client}),E&&{redirectUrl:E}),{lastAuth:V.getLastAuth(te),abTestingKey:Y,locale:G.getUserLocale(N).locale,nativeOptions:ne,outboundAppId:Z,outboundAppScopes:ee}),Q,"",se.componentsVersion,re,Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.formConfigValues),I?{exchangeCode:I,idpInitiated:!0}:{}),J.descopeIdpInitiated&&{idpInitiated:!0}),O?{token:O}:{}),J.oidcLoginHint?{externalId:J.oidcLoginHint}:{}));return x.__classPrivateFieldGet(this,b,"f").call(this,e),void("completed"!==(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.status)&&this.flowState.update({code:void 0,token:void 0}))}}if(this.loggerWrapper.debug("Before popup postmessage send",JSON.stringify({isPopup:R,code:I,exchangeError:P,isCodeChanged:o("code"),isExchangeErrorChanged:o("exchangeError")})),R&&(o("code")&&I||o("exchangeError")&&P)){this.loggerWrapper.debug("Creating popup channel",p);const e=new BroadcastChannel(p);return this.loggerWrapper.debug("Posting message to popup channel",JSON.stringify({code:I,exchangeError:P})),e.postMessage({data:{code:I,exchangeError:P},action:"code"}),this.loggerWrapper.debug("Popup channel message posted, closing channel"),e.close(),this.loggerWrapper.debug("Popup channel closed, closing window"),void window.close()}if(p&&(o("token")&&O||o("code")&&I||o("exchangeError")&&P)){const e=yield this.sdk.flow.next(p,u,U.CUSTOM_INTERACTIONS.submit,ie.version,se.componentsVersion,{token:O,exchangeCode:I,exchangeError:P});return x.__classPrivateFieldGet(this,b,"f").call(this,e),void this.flowState.update({token:void 0,code:void 0,exchangeError:void 0})}if(v===U.RESPONSE_ACTIONS.loadForm&&["samlIdpResponseUrl","samlIdpResponseSamlResponse","samlIdpResponseRelayState"].some((e=>o(e)))){if(!j||!D)return void this.loggerWrapper.error("Did not get saml idp params data to load");G.injectSamlIdpForm(j,D,M||"",G.submitForm)}if(v===U.RESPONSE_ACTIONS.redirect&&(o("redirectTo")||o("deferredRedirect"))){if(!S)return void this.loggerWrapper.error("Did not get redirect url");if("android"===k&&document.hidden)return void this.flowState.update({deferredRedirect:!0});if(this.loggerWrapper.debug(`Redirect is popup ${w}`),w){this.loggerWrapper.debug("Opening redirect in popup");const t=G.openCenteredPopup(S,"?",598,700);this.loggerWrapper.debug("Creating broadcast channel");const i=new BroadcastChannel(p);this.loggerWrapper.debug("Starting popup closed detection");const s=setInterval((()=>{t.closed&&(this.loggerWrapper.debug("Popup closed, dispatching popupclosed event and clearing interval"),clearInterval(s),x.__classPrivateFieldGet(this,e,"m",W).call(this,"popupclosed",{}),this.loggerWrapper.debug("Closing channel"),i.close())}),1e3);this.loggerWrapper.debug("Listening for postMessage on channel");const r=e=>{if(this.loggerWrapper.debug("Received postMessage on channel",JSON.stringify(e)),this.loggerWrapper.debug("Comparing origins",JSON.stringify({eventOrigin:e.origin,windowLocationOrigin:window.location.origin})),e.origin!==window.location.origin)return;this.loggerWrapper.debug("PostMessage origin matches, processing message");const{action:t,data:i}=e.data;this.loggerWrapper.debug(`PostMessage action: ${t}, data: ${JSON.stringify(i)}`),"code"===t&&(this.loggerWrapper.debug("Updating flow state with code and exchangeError"),this.flowState.update({code:i.code,exchangeError:i.exchangeError}))};i.onmessage=r}else this.handleRedirect(S);return}if(v===U.RESPONSE_ACTIONS.webauthnCreate||v===U.RESPONSE_ACTIONS.webauthnGet){if(!C||!T)return void this.loggerWrapper.error("Did not get webauthn transaction id or options");let e,t;null===(a=x.__classPrivateFieldGet(this,i,"f"))||void 0===a||a.abort(),x.__classPrivateFieldSet(this,i,null,"f");try{e=v===U.RESPONSE_ACTIONS.webauthnCreate?yield this.sdk.webauthn.helpers.create(T):yield this.sdk.webauthn.helpers.get(T)}catch(e){"InvalidStateError"===e.name?this.loggerWrapper.warn("WebAuthn operation failed",e.message):"NotAllowedError"!==e.name&&this.loggerWrapper.error(e.message),t=e.name}const s=yield this.sdk.flow.next(p,u,U.CUSTOM_INTERACTIONS.submit,ie.version,se.componentsVersion,{transactionId:C,response:e,failure:t});x.__classPrivateFieldGet(this,b,"f").call(this,s)}if(v===U.RESPONSE_ACTIONS.nativeBridge)return this.nativeCallbacks.complete=e=>x.__awaiter(this,void 0,void 0,(function*(){const t=yield this.sdk.flow.next(p,u,U.CUSTOM_INTERACTIONS.submit,ie.version,se.componentsVersion,e);x.__classPrivateFieldGet(this,b,"f").call(this,t)})),void x.__classPrivateFieldGet(this,e,"m",l).call(this,B,K);if(o("action")&&x.__classPrivateFieldGet(this,_,"f").call(this,p,u,ie.version,se.componentsVersion),!m&&!X)return void this.loggerWrapper.warn("No screen was found to show");const le=X||m,de=yield this.getHtmlFilenameWithLocale(N,le),{oidcLoginHint:ce,oidcPrompt:he,oidcErrorRedirectUri:ue,oidcResource:pe,samlIdpUsername:ge}=J,ve={direction:G.getAnimationDirection(u,r.stepId),screenState:Object.assign(Object.assign({},f),{form:Object.assign(Object.assign({},this.formConfigValues),null==f?void 0:f.form),lastAuth:{loginId:te,name:this.sdk.getLastUserDisplayName()||te},componentsConfig:Object.assign(Object.assign(Object.assign({},ie.componentsConfig),ae),null==f?void 0:f.componentsConfig)}),htmlFilename:`${le}.html`,htmlLocaleFilename:de,screenId:le,stepName:t.stepName||z,samlIdpUsername:ge,oidcLoginHint:ce,oidcPrompt:he,oidcErrorRedirectUri:ue,oidcResource:pe,action:v},me=V.getLastAuth(te);G.showFirstScreenOnExecutionInit(X,J)?ve.next=(e,t)=>x.__awaiter(this,void 0,void 0,(function*(){const i=yield this.sdk.flow.start(c,Object.assign(Object.assign(Object.assign(Object.assign({tenant:h,redirectAuth:oe},J),{lastAuth:me,preview:this.preview,abTestingKey:Y,client:this.client}),E&&{redirectUrl:E}),{locale:G.getUserLocale(N).locale,nativeOptions:ne,outboundAppId:Z,outboundAppScopes:ee}),Q,e,se.componentsVersion,re,Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.formConfigValues),G.transformScreenInputs(t)),I&&{exchangeCode:I,idpInitiated:!0}),J.descopeIdpInitiated&&{idpInitiated:!0}),O&&{token:O}));return x.__classPrivateFieldGet(this,b,"f").call(this,i),i})):(o("projectId")||o("baseUrl")||o("executionId")||o("stepId"))&&(ve.next=(e,t)=>x.__awaiter(this,void 0,void 0,(function*(){const i=yield this.sdk.flow.next(p,u,e,ie.version,se.componentsVersion,G.transformScreenInputs(t));return x.__classPrivateFieldGet(this,b,"f").call(this,i),i}))),this.loggerWrapper.debug("Got a screen with id",ve.screenId),yield x.__classPrivateFieldGet(this,e,"m",g).call(this,ve),this.stepState.update(ve)}))}onStepChange(t,i){return x.__awaiter(this,void 0,void 0,(function*(){var s,r;const{htmlFilename:o,htmlLocaleFilename:n,direction:a,next:l,screenState:d}=t;this.loggerWrapper.debug("Rendering a flow screen");const c=document.createElement("template");c.innerHTML=yield this.getPageContent(o,n);const h=c.content.cloneNode(!0),u=this.loadDescopeUiComponents(c);this.sdk.webauthn.helpers.isSupported()?yield x.__classPrivateFieldGet(this,e,"m",E).call(this,h,l):D.disableWebauthnButtons(h),!t.samlIdpUsername||(null===(s=d.form)||void 0===s?void 0:s.loginId)||(null===(r=d.form)||void 0===r?void 0:r.email)||(d.form||(d.form={}),d.form.loginId=t.samlIdpUsername,d.form.email=t.samlIdpUsername),D.updateTemplateFromScreenState(h,d,d.componentsConfig,this.formConfig,this.loggerWrapper);const{geo:p}=yield this.getExecutionContext();D.setPhoneAutoDetectDefaultCode(h,p);const g=()=>x.__awaiter(this,void 0,void 0,(function*(){var s,r;yield u;const o=this.contentRootElement;D.setTOTPVariable(o,null===(s=null==d?void 0:d.totp)||void 0===s?void 0:s.image),D.setNOTPVariable(o,null===(r=null==d?void 0:d.notp)||void 0===r?void 0:r.image),D.setCssVars(o,h,d.cssVars,this.loggerWrapper),o.replaceChildren(h);const n=!i.htmlFilename;setTimeout((()=>{x.__classPrivateFieldGet(this,e,"m",y).call(this),this.validateOnBlur&&G.handleReportValidityOnBlur(o),D.updateScreenFromScreenState(o,d),x.__classPrivateFieldGet(this,e,"m",O).call(this,{isFirstScreen:n,isCustomScreen:!1,stepName:t.stepName}),G.handleAutoFocus(o,this.autoFocus,n)})),x.__classPrivateFieldGet(this,e,"m",N).call(this,l);o.querySelector(`[${U.ELEMENT_TYPE_ATTRIBUTE}="polling"]`)&&l(U.CUSTOM_INTERACTIONS.polling,{})}));a?x.__classPrivateFieldGet(this,e,"m",m).call(this,g):g()}))}getInputs(){return Array.from(this.shadowRoot.querySelectorAll(`*:not(slot)[name]:not([${U.DESCOPE_ATTRIBUTE_EXCLUDE_FIELD}])`))}};
//# sourceMappingURL=DescopeWc.js.map
