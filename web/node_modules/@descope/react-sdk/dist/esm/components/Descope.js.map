{"version":3,"file":"Descope.js","sources":["../../../src/components/Descope.tsx"],"sourcesContent":["/* eslint-disable react/prop-types */\nimport React, {\n  lazy,\n  Suspense,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  useMemo,\n  useState,\n} from 'react';\nimport { baseHeaders } from '../constants';\nimport Context from '../hooks/Context';\nimport { DescopeProps } from '../types';\nimport { getGlobalSdk } from '../sdk';\nimport withPropsMapping from './withPropsMapping';\n\n// web-component code uses browser API, but can be used in SSR apps, hence the lazy loading\nconst DescopeWC = lazy(async () => {\n  const updateDynamicHeader = (key: string, value: string) => {\n    if (value) {\n      baseHeaders[key] = value;\n    } else {\n      delete baseHeaders[key];\n    }\n  };\n\n  const WebComponent: any =\n    customElements?.get('descope-wc') ||\n    (await import('@descope/web-component').then((module) => module.default));\n\n  WebComponent.sdkConfigOverrides = {\n    // Overrides the web-component's base headers to indicate usage via the React SDK\n    baseHeaders,\n    // Disables token persistence within the web-component to delegate token management\n    // to the global SDK hooks. This ensures token handling aligns with the SDK's configuration,\n    // and web-component requests leverage the global SDK's beforeRequest hooks for consistency\n    persistTokens: false,\n    hooks: {\n      get beforeRequest() {\n        // Retrieves the beforeRequest hook from the global SDK, which is initialized\n        // within the AuthProvider using the desired configuration. This approach ensures\n        // the web-component utilizes the same beforeRequest hooks as the global SDK\n        return getGlobalSdk().httpClient.hooks.beforeRequest;\n      },\n      set beforeRequest(_) {\n        // The empty setter prevents runtime errors when attempts are made to assign a value to 'beforeRequest'.\n        // JavaScript objects default to having both getters and setters\n      },\n    },\n  };\n\n  return {\n    default: withPropsMapping(\n      React.forwardRef<HTMLElement>(\n        ({ 'external-request-id': externalRequestId, ...props }: any, ref) => {\n          // update the dynamic headers with the external request ID if provided\n          useMemo(() => {\n            updateDynamicHeader('x-external-rid', externalRequestId);\n          }, [externalRequestId]);\n\n          return <descope-wc ref={ref} {...props} />;\n        },\n      ),\n    ),\n  };\n});\n\nconst Descope = React.forwardRef<HTMLElement, DescopeProps>(\n  (\n    {\n      flowId,\n      onSuccess,\n      onError,\n      onReady,\n      logger,\n      tenant,\n      theme,\n      nonce,\n      locale,\n      debug,\n      client,\n      form,\n      telemetryKey,\n      redirectUrl,\n      autoFocus,\n      validateOnBlur,\n      restartOnError,\n      errorTransformer,\n      styleId,\n      onScreenUpdate,\n      dismissScreenErrorOnInput,\n      outboundAppId,\n      outboundAppScopes,\n      children,\n      externalRequestId,\n    },\n    ref,\n  ) => {\n    const [innerRef, setInnerRef] = useState(null);\n\n    useImperativeHandle(ref, () => innerRef);\n\n    const {\n      projectId,\n      baseUrl,\n      baseStaticUrl,\n      baseCdnUrl,\n      storeLastAuthenticatedUser,\n      keepLastAuthenticatedUserAfterLogout,\n      refreshCookieName,\n      sdk,\n    } = React.useContext(Context);\n\n    const handleSuccess = useCallback(\n      async (e: CustomEvent) => {\n        // In order to make sure all the after-hooks are running with the success response\n        // we are generating a fake response with the success data and calling the http client after hook fn with it\n        await sdk.httpClient.hooks.afterRequest(\n          {} as any,\n          new Response(JSON.stringify(e.detail)),\n        );\n        if (onSuccess) {\n          onSuccess(e);\n        }\n      },\n      [onSuccess],\n    );\n\n    useEffect(() => {\n      const ele = innerRef;\n      ele?.addEventListener('success', handleSuccess);\n      if (onError) ele?.addEventListener('error', onError);\n      if (onReady) ele?.addEventListener('ready', onReady);\n\n      return () => {\n        if (onError) ele?.removeEventListener('error', onError);\n        if (onReady) ele?.removeEventListener('ready', onReady);\n\n        ele?.removeEventListener('success', handleSuccess);\n      };\n    }, [innerRef, onError, handleSuccess]);\n\n    // Success event\n    useEffect(() => {\n      const ele = innerRef;\n      ele?.addEventListener('success', handleSuccess);\n      return () => {\n        ele?.removeEventListener('success', handleSuccess);\n      };\n    }, [innerRef, handleSuccess]);\n\n    // Error event\n    useEffect(() => {\n      const ele = innerRef;\n      if (onError) ele?.addEventListener('error', onError);\n\n      return () => {\n        if (onError) ele?.removeEventListener('error', onError);\n      };\n    }, [innerRef, onError]);\n\n    // Ready event\n    useEffect(() => {\n      const ele = innerRef;\n      if (onReady) ele?.addEventListener('ready', onReady);\n\n      return () => {\n        if (onReady) ele?.removeEventListener('error', onReady);\n      };\n    }, [innerRef, onReady]);\n\n    return (\n      /**\n       * in order to avoid redundant remounting of the WC, we are wrapping it with a form element\n       * this workaround is done in order to support webauthn passkeys\n       * it can be removed once this issue will be solved\n       * https://bugs.chromium.org/p/chromium/issues/detail?id=1404106#c2\n       */\n\t<form>\n\t\t<Suspense fallback={null}>\n\t\t\t<DescopeWC\n            projectId={projectId}\n            flowId={flowId}\n            baseUrl={baseUrl}\n            baseStaticUrl={baseStaticUrl}\n            baseCdnUrl={baseCdnUrl}\n            ref={setInnerRef}\n            telemetryKey={telemetryKey}\n            redirectUrl={redirectUrl}\n            autoFocus={autoFocus}\n            styleId={styleId}\n            validateOnBlur={validateOnBlur}\n            restartOnError={restartOnError}\n            keepLastAuthenticatedUserAfterLogout={\n              keepLastAuthenticatedUserAfterLogout\n            }\n            tenant={tenant}\n            externalRequestId={externalRequestId}\n            {...{\n              // attributes\n              'theme.attr': theme,\n              'nonce.attr': nonce,\n              'locale.attr': locale,\n              'form.attr': form,\n              'client.attr': client,\n              'debug.attr': debug,\n              'outbound-app-id.attr': outboundAppId,\n              'outbound-app-scopes.attr': outboundAppScopes,\n              'store-last-authenticated-user.attr': storeLastAuthenticatedUser,\n              'refreshCookieName.attr': refreshCookieName,\n              'dismiss-screen-error-on-input.attr': dismissScreenErrorOnInput,\n              // props\n              'errorTransformer.prop': errorTransformer,\n              'logger.prop': logger,\n              'onScreenUpdate.prop': onScreenUpdate,\n            }}\n          >\n\t\t\t\t{children}\n\t\t\t</DescopeWC>\n\t\t</Suspense>\n\t</form>\n    );\n  },\n);\n\nexport default Descope;\n"],"names":["DescopeWC","lazy","async","customElements","get","import","then","module","default","sdkConfigOverrides","baseHeaders","persistTokens","hooks","beforeRequest","getGlobalSdk","httpClient","_","withPropsMapping","React","forwardRef","_a","ref","externalRequestId","props","__rest","useMemo","key","value","Descope","flowId","onSuccess","onError","onReady","logger","tenant","theme","nonce","locale","debug","client","form","telemetryKey","redirectUrl","autoFocus","validateOnBlur","restartOnError","errorTransformer","styleId","onScreenUpdate","dismissScreenErrorOnInput","outboundAppId","outboundAppScopes","children","innerRef","setInnerRef","useState","useImperativeHandle","projectId","baseUrl","baseStaticUrl","baseCdnUrl","storeLastAuthenticatedUser","keepLastAuthenticatedUserAfterLogout","refreshCookieName","sdk","useContext","Context","handleSuccess","useCallback","e","afterRequest","Response","JSON","stringify","detail","useEffect","ele","addEventListener","removeEventListener","createElement","Suspense","fallback"],"mappings":"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"}