{"version":3,"file":"createStateManagementMixin.js","sources":["../../../src/mixins/createStateManagementMixin.ts"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport { compose, createSingletonMixin } from '@descope/sdk-helpers';\nimport type {\n  CreateSliceOptions,\n  Draft,\n  SliceCaseReducers,\n  SliceSelectors,\n} from '@reduxjs/toolkit';\nimport { configureStore, createSlice, unwrapResult } from '@reduxjs/toolkit';\nimport type { Unsubscribe } from 'redux'; //  workaround for https://github.com/microsoft/TypeScript/issues/42873\nimport { loggerMixin } from './loggerMixin';\n\nexport const createStateManagementMixin = <\n  State,\n  CaseReducers extends SliceCaseReducers<State>,\n  Name extends string,\n  Selectors extends SliceSelectors<State>,\n  ReducerPath extends string = Name,\n  AsyncActions extends Record<string, any> = {},\n>(\n  options: CreateSliceOptions<\n    State,\n    CaseReducers,\n    Name,\n    ReducerPath,\n    Selectors\n  > & { asyncActions?: AsyncActions },\n) =>\n  createSingletonMixin(<T extends CustomElementConstructor>(superclass: T) => {\n    const slice = createSlice(options);\n\n    const allActions = { ...slice.actions, ...options.asyncActions };\n\n    return class StateManagementMixinClass extends compose(loggerMixin)(\n      superclass,\n    ) {\n      actions: typeof allActions;\n\n      subscribe: <SelectorR = State extends Draft<infer S> ? S : State>(\n        cb: (state: SelectorR) => void,\n        selector?: (state: State) => SelectorR,\n      ) => Unsubscribe;\n\n      constructor(...args: any) {\n        super(...args);\n\n        const store = configureStore({\n          reducer: slice.reducer,\n          middleware: (getDefaultMiddleware) =>\n            getDefaultMiddleware({\n              thunk: {\n                extraArgument: this,\n              },\n              serializableCheck: false,\n            }),\n          // change to true if we want to debug redux\n          devTools: false,\n        });\n\n        const wrapAction = <F extends (...args: any[]) => any>(action: F) =>\n          (async (...arg: any[]) => {\n            const result = await store.dispatch(action(...arg));\n\n            // we want to unwrap the result, so in case of an error we can log it\n            try {\n              unwrapResult(result);\n            } catch (e) {\n              this.logger.error(e.message, result.type, e.stack);\n            }\n\n            return result;\n          }) as F;\n\n        const actions = Object.keys(allActions).reduce((acc, actionName) => {\n          acc[actionName] = wrapAction(allActions[actionName]);\n\n          return acc;\n        }, {}) as typeof slice.actions & typeof options.asyncActions;\n\n        this.actions = actions;\n\n        this.subscribe = (cb, selector = (state) => state as any) =>\n          store.subscribe(() => cb(selector(store.getState())));\n      }\n    };\n  });\n"],"names":["createSingletonMixin","createSlice","compose","loggerMixin","configureStore","unwrapResult"],"mappings":";;;;;;AAAA;AAYO,MAAM,0BAA0B,GAAG,CAQxC,OAMmC,KAEnCA,+BAAoB,CAAC,CAAqC,UAAa,KAAI;AACzE,IAAA,MAAM,KAAK,GAAGC,mBAAW,CAAC,OAAO,CAAC,CAAC;IAEnC,MAAM,UAAU,GAAQ,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,EAAA,EAAA,KAAK,CAAC,OAAO,GAAK,OAAO,CAAC,YAAY,CAAE,CAAC;IAEjE,OAAO,MAAM,yBAA0B,SAAQC,kBAAO,CAACC,uBAAW,CAAC,CACjE,UAAU,CACX,CAAA;AAQC,QAAA,WAAA,CAAY,GAAG,IAAS,EAAA;AACtB,YAAA,KAAK,CAAC,GAAG,IAAI,CAAC,CAAC;YAEf,MAAM,KAAK,GAAGC,sBAAc,CAAC;gBAC3B,OAAO,EAAE,KAAK,CAAC,OAAO;AACtB,gBAAA,UAAU,EAAE,CAAC,oBAAoB,KAC/B,oBAAoB,CAAC;AACnB,oBAAA,KAAK,EAAE;AACL,wBAAA,aAAa,EAAE,IAAI;AACpB,qBAAA;AACD,oBAAA,iBAAiB,EAAE,KAAK;iBACzB,CAAC;;AAEJ,gBAAA,QAAQ,EAAE,KAAK;AAChB,aAAA,CAAC,CAAC;AAEH,YAAA,MAAM,UAAU,GAAG,CAAoC,MAAS,MAC7D,OAAO,GAAG,GAAU,KAAI;AACvB,gBAAA,MAAM,MAAM,GAAG,MAAM,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;;AAGpD,gBAAA,IAAI;oBACFC,oBAAY,CAAC,MAAM,CAAC,CAAC;iBACtB;gBAAC,OAAO,CAAC,EAAE;AACV,oBAAA,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC;iBACpD;AAED,gBAAA,OAAO,MAAM,CAAC;AAChB,aAAC,CAAM,CAAC;AAEV,YAAA,MAAM,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,UAAU,KAAI;gBACjE,GAAG,CAAC,UAAU,CAAC,GAAG,UAAU,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC;AAErD,gBAAA,OAAO,GAAG,CAAC;aACZ,EAAE,EAAE,CAAuD,CAAC;AAE7D,YAAA,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;AAEvB,YAAA,IAAI,CAAC,SAAS,GAAG,CAAC,EAAE,EAAE,QAAA,GAAW,CAAC,KAAK,KAAK,KAAY,KACtD,KAAK,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,CAAC;SACzD;KACF,CAAC;AACJ,CAAC;;;;"}