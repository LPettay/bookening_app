{"version":3,"file":"descopeUiMixin.js","sources":["../../../../src/mixins/descopeUiMixin/descopeUiMixin.ts"],"sourcesContent":["import { compose, createSingletonMixin } from '@descope/sdk-helpers';\nimport { configMixin } from '../configMixin';\nimport { injectNpmLibMixin } from '../injectNpmLibMixin';\nimport { loggerMixin } from '../loggerMixin';\nimport { getDescopeUiComponentsList } from './helpers';\nimport {\n  JS_FILE_PATH,\n  LOCAL_STORAGE_OVERRIDE,\n  WEB_COMPONENTS_UI_LIB_NAME,\n} from './constants';\n\nexport const descopeUiMixin = createSingletonMixin(\n  <T extends CustomElementConstructor>(superclass: T) => {\n    const BaseClass = compose(\n      loggerMixin,\n      configMixin,\n      injectNpmLibMixin,\n    )(superclass);\n\n    return class DescopeUiMixinClass extends BaseClass {\n      // eslint-disable-next-line class-methods-use-this\n      async #getComponentsVersion() {\n        const config = await this.config;\n        const componentsVersion = config?.projectConfig?.componentsVersion;\n\n        if (!componentsVersion) {\n          this.logger.error('Could not get components version');\n        } else {\n          this.logger.debug(`Got component version \"${componentsVersion}\"`);\n        }\n\n        return componentsVersion;\n      }\n\n      #descopeUi: Promise<any>;\n\n      get descopeUi() {\n        if (!this.#descopeUi) {\n          this.#descopeUi = this.#getDescopeUi();\n        }\n\n        return this.#descopeUi;\n      }\n\n      async #loadDescopeUiComponent(componentName: string) {\n        const isComponentAlreadyDefined = !!customElements.get(componentName);\n\n        if (isComponentAlreadyDefined) {\n          this.logger.debug(\n            `Loading component \"${componentName}\" is skipped as it is already defined`,\n          );\n          return undefined;\n        }\n\n        const descopeUI = await this.descopeUi;\n\n        if (!descopeUI[componentName]) {\n          this.logger.error(\n            `Cannot load UI component \"${componentName}\"`,\n            `Descope UI does not have a component named \"${componentName}\", available components are: \"${Object.keys(\n              descopeUI,\n            ).join(', ')}\"`,\n          );\n          return undefined;\n        }\n\n        try {\n          // eslint-disable-next-line @typescript-eslint/return-await\n          return await descopeUI[componentName]();\n        } catch (e) {\n          // this error is thrown when trying to register a component which is already registered\n          // when running 2 flows on the same page, it might happen that the register fn is called twice\n          // in case it happens, we are silently ignore the error\n          if (e.name === 'NotSupportedError') {\n            // eslint-disable-next-line no-console\n            console.debug(\n              `Encountered an error while attempting to define the \"${componentName}\" component, it is likely that this component is already defined`,\n            );\n          } else {\n            throw e;\n          }\n        }\n\n        return undefined;\n      }\n\n      async #getDescopeUi() {\n        if (globalThis.DescopeUI) {\n          return globalThis.DescopeUI;\n        }\n\n        try {\n          await this.injectNpmLib(\n            WEB_COMPONENTS_UI_LIB_NAME,\n            await this.#getComponentsVersion(),\n            JS_FILE_PATH,\n            [LOCAL_STORAGE_OVERRIDE],\n          );\n          this.logger.debug('DescopeUI was loaded');\n          return globalThis.DescopeUI;\n        } catch (error) {\n          this.logger.error(error);\n          throw new Error('DescopeUI was not loaded');\n        }\n      }\n\n      async loadDescopeUiComponents(\n        templateOrComponentNames: HTMLTemplateElement | string[],\n      ) {\n        const descopeUiComponentsList = Array.isArray(templateOrComponentNames)\n          ? templateOrComponentNames\n          : getDescopeUiComponentsList(templateOrComponentNames);\n\n        return Promise.all(\n          descopeUiComponentsList.map((componentName: string) =>\n            this.#loadDescopeUiComponent(componentName),\n          ),\n        );\n      }\n    };\n  },\n);\n"],"names":[],"mappings":"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"}